#!/usr/bin/env zunit

@setup {
    load ../fzf-zsh-completions.plugin.zsh
}

@teardown {
    rm -f docker_mock_times
}

@test 'Testing completion: docker **' {
    _fzf_complete() {
        fail '_fzf_complete should not be invoked'
    }

    _fzf_path_completion() {
        assert $# equals 2
        assert $1 same_as ''
        assert $2 same_as 'docker '
    }

    prefix=
    _fzf_complete_docker 'docker '
}

@test 'Testing completion: docker create **' {
    echo 0 > docker_mock_times

    docker() {
        docker_mock_times=$(($(cat docker_mock_times) + 1))
        echo $docker_mock_times > docker_mock_times

        docker_mock_$docker_mock_times $@
    }

    docker_mock_1() {
        assert $# equals 3
        assert $1 same_as 'images'
        assert $2 same_as '--format'
        assert $3 same_as 'table {{.ID}};{{.Repository}};{{.Tag}};{{if .CreatedSince}}{{.CreatedSince}}{{else}}N/A{{end}};{{.Size}}'

        echo 'IMAGE ID;REPOSITORY;TAG;CREATED;SIZE'
        echo 'e7d92cdc71fe;alpine;latest;18 hours ago;5.59MB'
        echo '5425b1e460b6;<none>;<none>;1 weeks ago;5.59MB'
        echo 'ccc6e87d482b;ubuntu;latest;7 weeks ago;64.2MB'
        echo 'f17f844b1558;zshusers/zsh;master;8 weeks ago;64.3MB'
        echo '0152bf6f0800;archlinux;latest;18 months ago;409MB'
    }

    _fzf_complete() {
        assert $# equals 2
        assert $1 matches '--ansi --tiebreak=index --header-lines=1 '
        assert $2 same_as 'docker create '

        run cat
        assert ${#lines} equals 6
        assert ${lines[1]} same_as "${fg[yellow]}IMAGE ID    ${reset_color}  ${reset_color}REPOSITORY  ${reset_color}  ${reset_color}TAG   ${reset_color}  ${reset_color}CREATED      ${reset_color}  SIZE"
        assert ${lines[2]} same_as "${fg[yellow]}e7d92cdc71fe${reset_color}  ${reset_color}alpine      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 hours ago ${reset_color}  5.59MB"
        assert ${lines[3]} same_as "${fg[yellow]}5425b1e460b6${reset_color}  ${reset_color}<none>      ${reset_color}  ${reset_color}<none>${reset_color}  ${reset_color}1 weeks ago  ${reset_color}  5.59MB"
        assert ${lines[4]} same_as "${fg[yellow]}ccc6e87d482b${reset_color}  ${reset_color}ubuntu      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}7 weeks ago  ${reset_color}  64.2MB"
        assert ${lines[5]} same_as "${fg[yellow]}f17f844b1558${reset_color}  ${reset_color}zshusers/zsh${reset_color}  ${reset_color}master${reset_color}  ${reset_color}8 weeks ago  ${reset_color}  64.3MB"
        assert ${lines[6]} same_as "${fg[yellow]}0152bf6f0800${reset_color}  ${reset_color}archlinux   ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 months ago${reset_color}  409MB"
    }

    prefix=
    _fzf_complete_docker 'docker create '
}

@test 'Testing completion: docker history **' {
    echo 0 > docker_mock_times

    docker() {
        docker_mock_times=$(($(cat docker_mock_times) + 1))
        echo $docker_mock_times > docker_mock_times

        docker_mock_$docker_mock_times $@
    }

    docker_mock_1() {
        assert $# equals 3
        assert $1 same_as 'images'
        assert $2 same_as '--format'
        assert $3 same_as 'table {{.ID}};{{.Repository}};{{.Tag}};{{if .CreatedSince}}{{.CreatedSince}}{{else}}N/A{{end}};{{.Size}}'

        echo 'IMAGE ID;REPOSITORY;TAG;CREATED;SIZE'
        echo 'e7d92cdc71fe;alpine;latest;18 hours ago;5.59MB'
        echo '5425b1e460b6;<none>;<none>;1 weeks ago;5.59MB'
        echo 'ccc6e87d482b;ubuntu;latest;7 weeks ago;64.2MB'
        echo 'f17f844b1558;zshusers/zsh;master;8 weeks ago;64.3MB'
        echo '0152bf6f0800;archlinux;latest;18 months ago;409MB'
    }

    _fzf_complete() {
        assert $# equals 2
        assert $1 matches '--ansi --tiebreak=index --header-lines=1 '
        assert $2 same_as 'docker history '

        run cat
        assert ${#lines} equals 6
        assert ${lines[1]} same_as "${fg[yellow]}IMAGE ID    ${reset_color}  ${reset_color}REPOSITORY  ${reset_color}  ${reset_color}TAG   ${reset_color}  ${reset_color}CREATED      ${reset_color}  SIZE"
        assert ${lines[2]} same_as "${fg[yellow]}e7d92cdc71fe${reset_color}  ${reset_color}alpine      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 hours ago ${reset_color}  5.59MB"
        assert ${lines[3]} same_as "${fg[yellow]}5425b1e460b6${reset_color}  ${reset_color}<none>      ${reset_color}  ${reset_color}<none>${reset_color}  ${reset_color}1 weeks ago  ${reset_color}  5.59MB"
        assert ${lines[4]} same_as "${fg[yellow]}ccc6e87d482b${reset_color}  ${reset_color}ubuntu      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}7 weeks ago  ${reset_color}  64.2MB"
        assert ${lines[5]} same_as "${fg[yellow]}f17f844b1558${reset_color}  ${reset_color}zshusers/zsh${reset_color}  ${reset_color}master${reset_color}  ${reset_color}8 weeks ago  ${reset_color}  64.3MB"
        assert ${lines[6]} same_as "${fg[yellow]}0152bf6f0800${reset_color}  ${reset_color}archlinux   ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 months ago${reset_color}  409MB"
    }

    prefix=
    _fzf_complete_docker 'docker history '
}

@test 'Testing completion: docker run **' {
    echo 0 > docker_mock_times

    docker() {
        docker_mock_times=$(($(cat docker_mock_times) + 1))
        echo $docker_mock_times > docker_mock_times

        docker_mock_$docker_mock_times $@
    }

    docker_mock_1() {
        assert $# equals 3
        assert $1 same_as 'images'
        assert $2 same_as '--format'
        assert $3 same_as 'table {{.ID}};{{.Repository}};{{.Tag}};{{if .CreatedSince}}{{.CreatedSince}}{{else}}N/A{{end}};{{.Size}}'

        echo 'IMAGE ID;REPOSITORY;TAG;CREATED;SIZE'
        echo 'e7d92cdc71fe;alpine;latest;18 hours ago;5.59MB'
        echo '5425b1e460b6;<none>;<none>;1 weeks ago;5.59MB'
        echo 'ccc6e87d482b;ubuntu;latest;7 weeks ago;64.2MB'
        echo 'f17f844b1558;zshusers/zsh;master;8 weeks ago;64.3MB'
        echo '0152bf6f0800;archlinux;latest;18 months ago;409MB'
    }

    _fzf_complete() {
        assert $# equals 2
        assert $1 matches '--ansi --tiebreak=index --header-lines=1 '
        assert $2 same_as 'docker run '

        run cat
        assert ${#lines} equals 6
        assert ${lines[1]} same_as "${fg[yellow]}IMAGE ID    ${reset_color}  ${reset_color}REPOSITORY  ${reset_color}  ${reset_color}TAG   ${reset_color}  ${reset_color}CREATED      ${reset_color}  SIZE"
        assert ${lines[2]} same_as "${fg[yellow]}e7d92cdc71fe${reset_color}  ${reset_color}alpine      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 hours ago ${reset_color}  5.59MB"
        assert ${lines[3]} same_as "${fg[yellow]}5425b1e460b6${reset_color}  ${reset_color}<none>      ${reset_color}  ${reset_color}<none>${reset_color}  ${reset_color}1 weeks ago  ${reset_color}  5.59MB"
        assert ${lines[4]} same_as "${fg[yellow]}ccc6e87d482b${reset_color}  ${reset_color}ubuntu      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}7 weeks ago  ${reset_color}  64.2MB"
        assert ${lines[5]} same_as "${fg[yellow]}f17f844b1558${reset_color}  ${reset_color}zshusers/zsh${reset_color}  ${reset_color}master${reset_color}  ${reset_color}8 weeks ago  ${reset_color}  64.3MB"
        assert ${lines[6]} same_as "${fg[yellow]}0152bf6f0800${reset_color}  ${reset_color}archlinux   ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 months ago${reset_color}  409MB"
    }

    prefix=
    _fzf_complete_docker 'docker run '
}

@test 'Testing completion: docker rmi **' {
    echo 0 > docker_mock_times

    docker() {
        docker_mock_times=$(($(cat docker_mock_times) + 1))
        echo $docker_mock_times > docker_mock_times

        docker_mock_$docker_mock_times $@
    }

    docker_mock_1() {
        assert $# equals 3
        assert $1 same_as 'images'
        assert $2 same_as '--format'
        assert $3 same_as 'table {{.ID}};{{.Repository}};{{.Tag}};{{if .CreatedSince}}{{.CreatedSince}}{{else}}N/A{{end}};{{.Size}}'

        echo 'IMAGE ID;REPOSITORY;TAG;CREATED;SIZE'
        echo 'e7d92cdc71fe;alpine;latest;18 hours ago;5.59MB'
        echo '5425b1e460b6;<none>;<none>;1 weeks ago;5.59MB'
        echo 'ccc6e87d482b;ubuntu;latest;7 weeks ago;64.2MB'
        echo 'f17f844b1558;zshusers/zsh;master;8 weeks ago;64.3MB'
        echo '0152bf6f0800;archlinux;latest;18 months ago;409MB'
    }

    _fzf_complete() {
        assert $# equals 2
        assert $1 matches '--ansi --tiebreak=index --header-lines=1 --multi'
        assert $2 same_as 'docker rmi '

        run cat
        assert ${#lines} equals 6
        assert ${lines[1]} same_as "${fg[yellow]}IMAGE ID    ${reset_color}  ${reset_color}REPOSITORY  ${reset_color}  ${reset_color}TAG   ${reset_color}  ${reset_color}CREATED      ${reset_color}  SIZE"
        assert ${lines[2]} same_as "${fg[yellow]}e7d92cdc71fe${reset_color}  ${reset_color}alpine      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 hours ago ${reset_color}  5.59MB"
        assert ${lines[3]} same_as "${fg[yellow]}5425b1e460b6${reset_color}  ${reset_color}<none>      ${reset_color}  ${reset_color}<none>${reset_color}  ${reset_color}1 weeks ago  ${reset_color}  5.59MB"
        assert ${lines[4]} same_as "${fg[yellow]}ccc6e87d482b${reset_color}  ${reset_color}ubuntu      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}7 weeks ago  ${reset_color}  64.2MB"
        assert ${lines[5]} same_as "${fg[yellow]}f17f844b1558${reset_color}  ${reset_color}zshusers/zsh${reset_color}  ${reset_color}master${reset_color}  ${reset_color}8 weeks ago  ${reset_color}  64.3MB"
        assert ${lines[6]} same_as "${fg[yellow]}0152bf6f0800${reset_color}  ${reset_color}archlinux   ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 months ago${reset_color}  409MB"
    }

    prefix=
    _fzf_complete_docker 'docker rmi '
}

@test 'Testing completion: docker save **' {
    echo 0 > docker_mock_times

    docker() {
        docker_mock_times=$(($(cat docker_mock_times) + 1))
        echo $docker_mock_times > docker_mock_times

        docker_mock_$docker_mock_times $@
    }

    docker_mock_1() {
        assert $# equals 3
        assert $1 same_as 'images'
        assert $2 same_as '--format'
        assert $3 same_as 'table {{.ID}};{{.Repository}};{{.Tag}};{{if .CreatedSince}}{{.CreatedSince}}{{else}}N/A{{end}};{{.Size}}'

        echo 'IMAGE ID;REPOSITORY;TAG;CREATED;SIZE'
        echo 'e7d92cdc71fe;alpine;latest;18 hours ago;5.59MB'
        echo '5425b1e460b6;<none>;<none>;1 weeks ago;5.59MB'
        echo 'ccc6e87d482b;ubuntu;latest;7 weeks ago;64.2MB'
        echo 'f17f844b1558;zshusers/zsh;master;8 weeks ago;64.3MB'
        echo '0152bf6f0800;archlinux;latest;18 months ago;409MB'
    }

    _fzf_complete() {
        assert $# equals 2
        assert $1 matches '--ansi --tiebreak=index --header-lines=1 --multi'
        assert $2 same_as 'docker save '

        run cat
        assert ${#lines} equals 6
        assert ${lines[1]} same_as "${fg[yellow]}IMAGE ID    ${reset_color}  ${reset_color}REPOSITORY  ${reset_color}  ${reset_color}TAG   ${reset_color}  ${reset_color}CREATED      ${reset_color}  SIZE"
        assert ${lines[2]} same_as "${fg[yellow]}e7d92cdc71fe${reset_color}  ${reset_color}alpine      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 hours ago ${reset_color}  5.59MB"
        assert ${lines[3]} same_as "${fg[yellow]}5425b1e460b6${reset_color}  ${reset_color}<none>      ${reset_color}  ${reset_color}<none>${reset_color}  ${reset_color}1 weeks ago  ${reset_color}  5.59MB"
        assert ${lines[4]} same_as "${fg[yellow]}ccc6e87d482b${reset_color}  ${reset_color}ubuntu      ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}7 weeks ago  ${reset_color}  64.2MB"
        assert ${lines[5]} same_as "${fg[yellow]}f17f844b1558${reset_color}  ${reset_color}zshusers/zsh${reset_color}  ${reset_color}master${reset_color}  ${reset_color}8 weeks ago  ${reset_color}  64.3MB"
        assert ${lines[6]} same_as "${fg[yellow]}0152bf6f0800${reset_color}  ${reset_color}archlinux   ${reset_color}  ${reset_color}latest${reset_color}  ${reset_color}18 months ago${reset_color}  409MB"
    }

    prefix=
    _fzf_complete_docker 'docker save '
}

@test 'Testing post: docker' {
    input=(
        'e7d92cdc71fe  alpine        latest  18 hours ago   5.59MB'
        '5425b1e460b6  <none>        <none>  1 weeks ago    5.59MB'
        'f17f844b1558  zshusers/zsh  latest  8 weeks ago    64.3MB'
    )

    run _fzf_complete_docker-images_post <<< ${(F)input}

    assert $state equals 0
    assert ${#lines} equals 3
    assert ${lines[1]} same_as 'e7d92cdc71fe'
    assert ${lines[2]} same_as '5425b1e460b6'
    assert ${lines[3]} same_as 'f17f844b1558'
}
